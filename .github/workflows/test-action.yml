name: test action

on:
  push:
    branches:
      - main
      - 'releases/**'
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      mode:
        description: 'Assignment mode: auto or refactor'
        required: false
        default: 'auto'
        type: choice
        options:
          - auto
          - refactor
      label-override:
        description: 'Priority label to filter by (auto mode only)'
        required: false
        default: ''
        type: string
      force:
        description: 'Force assignment even if Copilot already has an issue assigned'
        required: false
        default: false
        type: boolean
      dry-run:
        description: 'Dry run mode - log what would be done without making changes'
        required: false
        default: true
        type: boolean
      allow-parent-issues:
        description: 'Allow assigning issues that have sub-issues'
        required: false
        default: false
        type: boolean
      skip-labels:
        description: 'Comma-separated list of labels to skip (e.g., no-ai,refining)'
        required: false
        default: 'no-ai,refining'
        type: string
      refactor-threshold:
        description: 'Number of closed issues to check for refactor label (default: 4)'
        required: false
        default: '4'
        type: string
      create-refactor-issue:
        description: 'Whether to create new refactor issues when none are available'
        required: false
        default: true
        type: boolean
      refactor-issue-template:
        description: 'Path to the issue template file for refactor issues'
        required: false
        default: '.github/REFACTOR_ISSUE_TEMPLATE.md'
        type: string
      wait-seconds:
        description: 'Number of seconds to wait before assigning (for issue events)'
        required: false
        default: '0'
        type: string

jobs:
  test-action:
    name: Test Auto Assign Copilot Action
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Test action with provided inputs
        id: test-action
        uses: ./
        with:
          github-token: ${{ secrets.COPILOT_ASSIGN_PAT }}
          mode: ${{ inputs.mode || 'auto' }}
          label-override: ${{ inputs.label-override || '' }}
          force: ${{ inputs.force || false }}
          dry-run: ${{ inputs.dry-run || true }}
          allow-parent-issues: ${{ inputs.allow-parent-issues || false }}
          skip-labels: ${{ inputs.skip-labels || 'no-ai,refining' }}
          refactor-threshold: ${{ inputs.refactor-threshold || '4' }}
          create-refactor-issue: ${{ inputs.create-refactor-issue || true }}
          refactor-issue-template: ${{ inputs.refactor-issue-template || '.github/REFACTOR_ISSUE_TEMPLATE.md' }}
          wait-seconds: ${{ inputs.wait-seconds || '0' }}

      - name: Display action outputs
        run: |
          echo "## Action Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Inputs Used:" >> $GITHUB_STEP_SUMMARY
          echo "- **Mode**: ${{ inputs.mode || 'auto' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Label Override**: ${{ inputs.label-override || '' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Force**: ${{ inputs.force || false }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Dry Run**: ${{ inputs.dry-run || true }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Allow Parent Issues**: ${{ inputs.allow-parent-issues || false }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Skip Labels**: ${{ inputs.skip-labels || 'no-ai,refining' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Refactor Threshold**: ${{ inputs.refactor-threshold || '4' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Create Refactor Issue**: ${{ inputs.create-refactor-issue || true }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Refactor Issue Template**: ${{ inputs.refactor-issue-template || '.github/REFACTOR_ISSUE_TEMPLATE.md' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Wait Seconds**: ${{ inputs.wait-seconds || '0' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Outputs:" >> $GITHUB_STEP_SUMMARY
          echo "- **Assigned Issue Number**: ${{ steps.test-action.outputs.assigned-issue-number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Assigned Issue URL**: ${{ steps.test-action.outputs.assigned-issue-url }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Assignment Mode**: ${{ steps.test-action.outputs.assignment-mode }}" >> $GITHUB_STEP_SUMMARY

  test-all-input-combinations:
    name: Test All Input Combinations
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
    strategy:
      fail-fast: false
      matrix:
        include:
          # Test dry-run mode with auto mode
          - mode: 'auto'
            dry-run: true
            label-override: ''
            force: false
            test-name: 'Auto mode with dry-run'

          # Test dry-run mode with refactor mode
          - mode: 'refactor'
            dry-run: true
            label-override: ''
            force: false
            test-name: 'Refactor mode with dry-run'

          # Test auto mode with label override
          - mode: 'auto'
            dry-run: true
            label-override: 'bug'
            force: false
            test-name: 'Auto mode with bug label override'

          # Test auto mode with force flag
          - mode: 'auto'
            dry-run: true
            label-override: ''
            force: true
            test-name: 'Auto mode with force flag'

          # Test with allow-parent-issues
          - mode: 'auto'
            dry-run: true
            label-override: ''
            force: false
            allow-parent-issues: true
            test-name: 'Auto mode allowing parent issues'

          # Test with custom skip-labels
          - mode: 'auto'
            dry-run: true
            label-override: ''
            force: false
            skip-labels: 'wip,blocked'
            test-name: 'Auto mode with custom skip labels'

          # Test with custom refactor threshold
          - mode: 'auto'
            dry-run: true
            label-override: ''
            force: false
            refactor-threshold: '2'
            test-name: 'Auto mode with custom refactor threshold'

          # Test with create-refactor-issue disabled
          - mode: 'refactor'
            dry-run: true
            label-override: ''
            force: false
            create-refactor-issue: false
            test-name: 'Refactor mode with create-refactor-issue disabled'

          # Test with custom wait-seconds
          - mode: 'auto'
            dry-run: true
            label-override: ''
            force: false
            wait-seconds: '60'
            test-name: 'Auto mode with custom wait-seconds'

          # Test with custom template (requires checkout)
          - mode: 'refactor'
            dry-run: true
            label-override: ''
            force: false
            refactor-issue-template: '.github/REFACTOR_ISSUE_TEMPLATE.md'
            test-name: 'Refactor mode with custom template'

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Test - ${{ matrix.test-name }}
        id: test
        uses: ./
        with:
          github-token: ${{ secrets.COPILOT_ASSIGN_PAT }}
          mode: ${{ matrix.mode }}
          label-override: ${{ matrix.label-override || '' }}
          force: ${{ matrix.force || false }}
          dry-run: ${{ matrix.dry-run || true }}
          allow-parent-issues: ${{ matrix.allow-parent-issues || false }}
          skip-labels: ${{ matrix.skip-labels || 'no-ai,refining' }}
          refactor-threshold: ${{ matrix.refactor-threshold || '4' }}
          create-refactor-issue: ${{ matrix.create-refactor-issue || true }}
          refactor-issue-template: ${{ matrix.refactor-issue-template || '.github/REFACTOR_ISSUE_TEMPLATE.md' }}
          wait-seconds: ${{ matrix.wait-seconds || '0' }}

      - name: Verify outputs are set
        run: |
          echo "Test: ${{ matrix.test-name }}"
          echo "Assigned Issue Number: ${{ steps.test.outputs.assigned-issue-number }}"
          echo "Assigned Issue URL: ${{ steps.test.outputs.assigned-issue-url }}"
          echo "Assignment Mode: ${{ steps.test.outputs.assignment-mode }}"
          
          # In dry-run mode, we should get outputs (issue number and URL may be empty if no suitable issue found)
          if [ "${{ matrix.dry-run }}" = "true" ]; then
            echo "âœ“ Dry-run mode test completed"
          fi
